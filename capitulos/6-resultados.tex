\chapter{Resultados obtidos}
\label{cap-resultados}
Este capítulo aborda os resultados encontrados, a partir da proposta de
definição e preparação dos estudos. 

Como dito no Capítulo \ref{cap-metodologia}, as aplicações piloto foram Owncloud e Wordpress. 
Cada fase da implantação será tratado como uma 
subseção na descrição de cada exemplo de uso. Todas as atividades foram organziadas,
via issues, no repositório do próprio projeto Shak 
\footnote{https://gitlab.com/shak/shak/issues}.

\section{Wordpress}
\label{sub:wordpress}

Wordpress é uma plataforma semântica de vanguarda para publicação pessoal, 
com foco na estética, nos padrões web e na usabilidade, ao mesmo tempo é 
um software livre. Além disso, Wordpress é um dos maiores softwares de 
publicação de conteúdo \cite{wordpress}. 

Primeiramente, foram seguido os procedimentos para a proposta da solução, que foram
 definidos na Seção \ref{section:construcao}. Para isso, é
necessário definir as fases e procedimentos da implantação automatizada,
seguindo as fases que compõem o processo proposto descrito na Seção \ref{sec:fases}.

\subsection{Planejamento}

Nesta fase é preciso definir quais são as dependências mínimas
para o funcionamento de uma aplicação, tais como: banco de dados; pacotes
pré-instalados; e aplicações pré-configuradas. Para o Wordpress foram escolhidas:

\begin{itemize}
   \item \textbf{Pacote Wordpress para o Debian:} Pacote Debian com o Wordpress.
   \item \textbf{Pacote Nginx para o Debian:} Pacote Debian com o Nginx.
   \item \textbf{Pacote MySQL para o Debian:} Pacote Debian com o banco de dados MySQL
   que será usado pelo Wordpress.
   \item \textbf{Arquivos de configuração:} Criação dos arquivos de configuração
   necessários para configurar o Wordpress, o servidor web Nginx e o banco de dados
   MySQL.
\end{itemize}

A instalação e execução desses recursos serão feitas nas fases seguintes.

\subsection{Preparação e Instalação de Pacotes}
\label{wordpress:preparacao}

São os procedimentos necessários para preparar o ambiente alvo para que o Wordpress
possa ser executado. Isso envolve a configuração do sistema operacional; instalação
e configuração de dependências necessárias; e a transferência do componente
para o servidor onde ele será executado.

Para o funcionamento correto do Wordpress é necessário a instalação do Php5. Além
disso, também é necessário algum servidor web. Na ferramenta Shak o servidor
web padrão é o Nginx e o banco de dados escolhido foi o MySQL.

Para esse procedimento, foi necessário instalar os pacotes php5-fpm; o pacote
do banco de dados MySQL; e o pacote Nginx. Além disso, habilitar o serviço do
php5-fpm. Todos esses passos são feitos antes da instalação do Wordpress,
pois, por padrão, ele instala o servidor
Apache2.

Para executar essas instalações, é preciso criar uma receita no livro de receitas
do Wordpress. Primeiramente, é necessário criar o próprio livro de receitas no Shak.
Para isso, existe o comando \textit{rake cookbook}, que cria a estrutura básica
de um livro de receitas que deve ser usado pelo Chef, como exempleficado no trecho
de código abaixo:

\begin{lstlisting}[language=Ruby,label=dice_index,caption={Exemplo de criação de estrutura básica de livro de receitas do wordpress com shak}]
  rake cookbook
  Cookbook name: wordpress
  knife cookbook create wordpress -o cookbooks/
  ** Creating cookbook foo in /home/thiago/Shak/cookbooks
  ** Creating README for cookbook: wordpress
  ** Creating CHANGELOG for cookbook: wordpress
  ** Creating metadata for cookbook: wordpress
\end{lstlisting}

Assim com a estrutura gerada pelo rake, é possível declarar as dependências do Wordpress
dentro do arquivo \textit{default.rb}, dentro da pasta \textit{recipes}. Nesse 
arquivo são declarados os pacotes que devem ser instalados; os arquivos de configuração;
os serviços que precisar executar; as pastas; e permissões de usuários. Um exemplo
de como declarar pacotes e serviços dentro de uma receita Chef é:

\begin{lstlisting}[language=Ruby,label=dice_index,caption={Exemplo de criação de serviço do mysql com o chef}]
  package "mysql-server"
  service "mysql" do
    action :start
  end
\end{lstlisting}


\subsection{Configuração}
\label{wordpress:preparacao}

Como levantado no planejamento, é necessário a edição de arquivos de configuração. Os
arquivos de configuração necessários são os arquivos de configuração do Wordpress; 
o arquivo de configuração do banco de dados; e arquivo de configuração do servidor Nginx.

O primeiro arquivo de configuração é o \textit{config.php}. Esse arquivo contém a
configuração onde ficam as informações de banco de dados, como nome do banco de dados;
login do usuário do banco de dados; senha; o endereço do banco de dados; e o diretório
onde irá ficar os arquivos estáticos, como temas; galeria de mídias; e plugins 
de cada instância do Wordpress.

Esse arquivo deve ficar no diretório \textit{/etc/wordpress/} e seu nome deve conter
a seguinte estrutura: \textit{config-nomehost.php}, onde o nomehost deve ser o hostname
desejado. O segundo arquivo é o \textit{database.sql}, que é um pequeno script \textit{SQL} que
cria o banco de dados do Wordpress e dá os privilégios ao usuário desejado. Por fim
o arquivo de configuração do Nginx, com a configuração do servidor web.

Na receita chef, esses arquivos de configuração serão criados dentro da pasta 
\textit{template}, com o conteúdo
desejado dos arquivos de configuração. A ação que cria o arquivo na receita chef é 
declarada dentro do arquivo \textit{default.rb}, de forma semelhante como foi feito com
a declaração dos pacotes. Um exemplo de como gerenciar templates numa receita Chef
é:

\begin{lstlisting}[language=Ruby,label=dice_index,caption={Exemplo de criação de templates com o chef}]
  template "text\_file.txt" do
  source "text\_file.txt"
  mode "0755"
  owner "root"
  group "root"
\end{lstlisting}

\subsection{Múltiplas Instâncias}

O uso de múltiplas instâncias do Wordpress pode ser feito de duas maneiras, e servem
para que o usuário possa ter várias instâncias de Wordpress no mesmo servidor. No 
Wordpress, é possível ter múltiplos sites e múltiplas
instâncias. No caso do Shak, é desejado que seja múltiplas instâncias, a partir da
repetição da instalação, porém isolando as aplicações.
 
Para isso, é necessário que algumas pastas do sistema
precisam ser divididas, sendo uma para cada aplicação. Cada instância precisa
ter seus diretórios isolados, o diretório \textit{wp-content} é o diretório 
que contém os uploads; os temas; os plugins, e etc. Portanto, para não
existir conflito entre as instâncias, essas pastas devem estar devidamente separadas
com seus caminhos referenciados em cada arquivo \textit{config.php}, o arquivo 
\textit{config.php} também
deve ser único para cada instância. 

Outro fator importante é que cada instância
tenha seu banco de dados, para evitar os conflitos. Para
solucionar esse problema o Shak possui um recurso interessante, onde cada aplicação
possui um atributo \textit{id}, que é um atributo único para cada instância executada pelo
Shak. Com isso, é possível criar pastas personalizadas com o id de cada aplicação, 
e também bancos de dados específicos e arquivos \textit{config.php} específicos.

Por fim, é necessário um arquivo de configuração Nginx para cada aplicação,
como visto no Capítulo \ref{cap-referencial}, todo arquivo de configuração
do Nginx possui um bloco server, e cada bloco server equivale a uma hospedagem virtual. 
Por isso as aplicações também se tornam independentes, podendo ser acessadas pelo 
mesmo sevidor, mas com endereços diferentes.

\subsection{Inicialização}

Após a construção da receita do Wordpress, é necessário testar a receita construída. 
Para isso o Shak precisa de duas informações importantes, a primeira é a aplicação
que será instalada, e segunda o hostname destino. Como é um ambiente de desenvolvimento,
não é preciso configurar um ip ou configurar um \textit{DNS}. É preciso adicionar o
hostname desejado no arquivo /etc/hosts. Assim, mesmo que esteja na sua máquina local
é possível acessar um endereço mais familiar em seu navegador. Um exemplo da execução
da instalação via Shak é:

\begin{lstlisting}[language=Ruby,label=dice_index,caption={Exemplo de exexução de instalação do wordpress com shak}]
shak install wordpress hostname=wordpress.dev
\end{lstlisting}

Dessa forma, o Chef inicia o processo de instalação dos pacotes; criação dos arquivos
de configuração; incia os serviços desejados; e ao fim do procedimento a aplicação
já estará pronta para uso no hostname escolhido.

\section{Owncloud}
\label{sub:owncloud}

Owncloud é uma ferramenta para compartilhamento de arquivos, é um software 
livre em que é possível compartilhar
um ou mais arquivos e pastas do seu computador na nuvem, e sincronizá-los com o seu
servidor Owncloud. Esses arquivos são imediatamente sincronizados com o servidor
e disponibilizados para outros dispositivos que utilizam o ambiente de trabalho
Owncloud ou app Android ou app IOS \cite{owncloud} .

Para a ferramenta Owncloud, foram seguidos os mesmos passos feitos em 
\ref{sub:wordpress}.

\subsection{Planejamento}

Inicialmente, é necessário definir quais são as dependências
mínimas para o funcionamento do Owncloud, tais como: banco de dados; pacotes
pré-instalados; e aplicações pré-configuradas. Para o Owncloud foram escolhidas:

\begin{itemize}
   \item \textbf{Pacote Owncloud para o Debian:} Pacote Debian com o Owncloud.
   \item \textbf{Pacote Nginx para o Debian:} Pacote Debian com o Nginx.
   \item \textbf{Pacote Postgresql para o Debian:} Pacote Debian com o banco de dados Postgresql
   que será usado pelo Owncloud.
   \item \textbf{Arquivos de configuração:} Criação dos arquivos de configuração
   necessários para configurar o Owncloud, o servidor web Nginx e o banco de dados
   Postgresql.
\end{itemize}

Diferentemente da aplicação Wordpress, na aplicação Owncloud o 
banco de dados escolhido foi o postgresql. Na documentação do Wordpress é recomendado
o uso do banco de dados MySQL, porém no Owncloud fica a escolha do desenvolvedor.
A escolha do Postgresql vêm com a possibilidade de trabalhar com dois bancos de
dados diferentes, aumentando o suporte do Shak. Assim, quando existirem aplicações
que suportam apenas o Postgresql, o Shak já terá uma estrutura pronta.

\subsection{Preparação e Instalação de Pacotes}

Para o funcionamento do Owncloud, é necessário a instalação do Php5. Além
disso, também foi utilizado o servidor web Nginx, e o 
banco de dados Postgresql.

Para esse procedimento, foi necessário instalar os pacotes php5-fpm; o banco
de dados Postgresql; e o pacote Nginx. Além disso, habilitar o serviço do php5-fpm. 
Também foi necessário instalar o pacote php5-pgsql, que é um módulo para
conexões de banco de dados Postgresql, necessário para o funcionamento de
aplicações na linguagem Php com o banco de dados Postgresql.

Para executar essas instalações, é preciso criar uma receita no livro de receitas
do Owncloud. Para isso, é necessário executar novamente o comando \textit{rake cookbook}, 
que cria a estrutura básica de um livro de receitas que deve ser usado pelo Chef, 
como exemplificado no trecho de código abaixo:

\begin{lstlisting}[language=Ruby,label=dice_index,caption={Exemplo de criação de estrutura básica de livro de receitas do Owncloud com Shak}]
  rake cookbook
  Cookbook name: owncloud
  knife cookbook create owncloud -o cookbooks/
  ** Creating cookbook foo in /home/thiago/Shak/cookbooks
  ** Creating README for cookbook: owncloud
  ** Creating CHANGELOG for cookbook: owncloud
  ** Creating metadata for cookbook: owncloud
\end{lstlisting}

Com a estrutura inicial, é possível declarar as dependências do Owncloud
dentro do arquivo \textit{default.rb}, que se encontra dentro da pasta 
\textit{recipes}. Nesse arquivo é 
declarado os pacotes que devem ser instalados; os arquivos de configuração;
os serviços que precisar executar; as pastas; permissões de usuários, etc. Um exemplo
de como declarar pacotes e serviços dentro de uma receita Chef é:

\begin{lstlisting}[language=Ruby,label=dice_index,caption={Exemplo de como habilitar serviço do postgresql com chef}]
  package "postgresql"
  service "postgresql" do
    action :start
  end
\end{lstlisting}

\subsection{Configuração}

Como levantado no planejamento, é necessário a edição de arquivos de configuração
do Owncloud; arquivos de configuração do banco de dados; e arquivo de configuração
do Nginx.

O primeiro arquivo de configuração é o \textit{autoconfig.php}, esse arquivo
contém informações iportantes, como nome do banco de dados;
login do usuário do banco de dados; senha do usuário do banco de dados; o endereço 
do banco de dados; o diretório
onde irá ficar os arquivos de configuração do Owncloud; e o login e senha
do administrador. Isso é necessário apenas para o primeiro acesso, ou seja, o usuário
fará o login automaticamente quando o Owncloud terminar a instalação. Após isso,
a recomendação é trocar a senha do administrador.

Além disso, é necessário criar a pasta de conteúdos públicos do Owncloud, que por
padrão devem ficar em \textit{/etc/owncloud}. O segundo arquivo é o 
\textit{postgresql-conf.sql}, que é um pequeno script \textit{SQL} que cria o 
banco de dados do Owncloud, e configura os
privilégios ao usuário desejado. Por fim, a configuração do servidor web, feitos
através de templates, da mesma forma que a aplicação Wordpress.

\subsection{Múltiplas Instâncias}

Diferentemente do Wordpress, o Owncloud não suporta múltiplas instâncias. Porém isso
não foi um impeditivo na execução do trabalho, com uma busca, encontrou-se uma 
discussão no repositório oficial do Owncloud relacionado a implementação dessa 
funcionalidade. 

A discussão está disponibilizada em 
\href{https://github.com/owncloud/core/pull/16424}, nela existia
uma proposta de solução ao fato de não existir a opção de múltiplas instâncias. O
resultado desta discussão foi que, os desenvolvedores do Owncloud não acharam relevante
a funcionalidade, mas caso o desenvolvedor ache necessário, ele poderia fazer essa
alteração diretamente no código fonte.

Porém, manter isso no Shak não seria uma boa solução. Uma solução para esse problema seria, 
enviar uma contribuição ao pacote do Owncloud no Debian, onde assim a contribuição feita
poderia ser facilmente utilizada por mais pessoas que queiram essa funcionalidade,
bastando utilizar a versão disponibilizada nos servidores do Debian. 

Com isso, foi feito a contribuição que adicionaria a funcionalidade de múltiplas 
instâncias para o Owncloud, e enviado ao mantenedor do pacote do Owncloud no Debian. 
A discussão está disponível em \href{https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=789726},
a contribuição foi bem vista pelo mantenedor do pacote, e será incorporada na nova
versão do Owncloud no Debian.

Em paralelo a isso,
foi necessário utilizar apenas instâncias únicas do Owncloud, porém, também foi
adicionado na receita do Owncloud o suporte a múltiplas instâncias. Portanto, 
assim que o Owncloud suportar múltiplas instâncias via pacote Debian, será possível
também criar múltiplas instâncias do Owncloud.

A solução feita na receita do Owncloud foi baseada na contribuição enviada, portanto
os testes foram feitos gerando um novo pacote Debian do Owncloud, porém, incorporando
a contribuição feita ao Debian. Os procedimentos feitos para suportar múltiplas instâncias
no Owncloud são bem semelhantes aos do Wordpress, criando um diretório de dados
para cada aplicação; um arquivo de configuração para cada aplicação; e um banco de
dados para cada aplicação. Seguindo a mesma abordagem do Wordpress, também
será criado uma hospedagem virtual para cada instância do Owncloud.

\subsection{Inicialização}

Após a construção da receita do Owncloud, é necessário testar a receita construída. 
Para isso o Shak precisa de duas informações importantes, a primeira é a aplicação
que será instalada, e segunda o endereço destino, para executar a instalação
do Owncloud basta:

\begin{lstlisting}[language=Ruby,label=dice_index,caption={Exemplo de execução de instalação do Owncloud com shak}]
shak install owncloud hostname=owncloud.dev
\end{lstlisting}

E assim, o Chef inicia o processo de instalação dos pacotes; criação dos arquivos
de configuração; incia os serviços desejados; e ao fim do procedimento, a aplicação
já estará pronta para uso no endereço escolhido.

\section{Servidor de e-mail}
\label{sub:e-mail}

Servidores de e-mail formam a infraestrutura do e-mail, sendo o \textit{SMTP} o protocolo
mais importante, pois é o responsável por transferir as mensagens de servidores
de e-mail remetentes para servidores de e-mail destinatários \cite{kurose2010redes}, 

Tanto Owncloud como Wordpress, possuem funcionalidades que utilizam serviços 
de e-mail. Logo, é necessário uma configuração mínima de e-mail para que funcione 
tais funcionalidades. Assim, a construção de um servidor de e-mail 
possui bastante relevância, para que qualquer aplicação que precisar de um 
servidor de e-mail, possa utilizar o servidor de e-mail que o Shak possa fornecer.

Para adicionar o suporte a servidor de e-mail, também foram seguidos os mesmos passos
feitos no Wordpress na Seção \ref{sub:wordpress} e no Owncloud na Seção\ref{sub:owncloud}. 

\subsection{Planejamento}

No planejamento, é necessário definir
quais são as dependências mínimas para o funcionamento do servidor de e-mail, é 
necessário configurar um servidor que utiliza o procolo \textit{IMAP} ou \textit{POP3};
também é necessário a configuração de um agente de transferência de e-mails; e também
alguma ferramenta para controle de spam.

Primeiramente, ficou definido que o protocolo escolhido seria o protocolo \textit{IMAP}, já
que o protocolo \textit{IMAP} é um protocolo online, ou seja, ele se conecta ao servidor
e realiza o download das mensagens, depois ainda  mantém a conexão para que
as alterações e mensagens novas sejam atualizadas em tempo real. Diferentemente do
protocolo \textit{POP3} que é um protocolo offline, onde após o download das mensagens encerra
a conexão. Outra vantagem do \textit{IMAP} em relação ao \textit{POP3} é que o 
\textit{IMAP} mantém uma cópia de mensagens no servidor, ideal para quem precisa 
acessar os e-mails de mais de um local.

O servidor \textit{IMAP} escolhido foi o Dovecot, que é um servidor de e-mail
\textit{IMAP}, além disso, dovecot é um software livre simples de configurar, requer nenhuma
administração especial, e ainda usa muito pouca memória \cite{dovecot}. 

O agente de transferência de e-mails escolhido foi o Postfix, que é um software
livre para envio e entrega de e-mails. Sua escolha foi feita pela facilidade de
integração com o Dovecot. Postfix é o software responsável pelo método de entrega de e-mail
utilizando \textit{SMTP}, como protocolo de transferência de e-mails. 

Por fim a aplicação que servirá como anti-spam será o Apache SpamAssassin, que 
é uma plataforma anti-spam que que dá aos administradores de servidor de e-mail, 
um filtro para classificar e-mails e bloquear os e-mails que julgarem como spam \cite{spam}. 

Em resumo, o servidor de email é composto de:

\begin{itemize}
   \item \textbf{Pacote dovecot para o Debian:} Pacote Debian com o dovecot.
   \item \textbf{Pacote postfix para o Debian:} Pacote Debian com o postfix.
   \item \textbf{Pacote spamassasin para o Debian:} Pacote Debian com o spamassasin.
   \item \textbf{Arquivos de configuração:} Criação dos arquivos de configuração
   necessários para configurar o spamassasin, dovecot e postfix.
\end{itemize}

\subsection{Preparação e Instalação de Pacotes }

É necessário separar as dependências dos pacotes para cada ferramenta
escolhida, para compor o servidor de e-mail. Primeiramente, para o postfix, são necessários
os pacotes postfix e bsd-mailx, além de habilitar o serviço do postfix. Para o dovecot,
é necessário instalar o pacote dovecot-imadp além de habilitar o serviço do dovecot. 
Para o spamassassin, são necessários os pacotes spamassassin e o pacote spamc, além 
de habilitar o serviço do spamassassin.

Na receita do servidor de e-mail, cada aplicação possui sua receita específica,
e o arquivo \textit{default.rb}, que contêm a receita do servidor de e-mail, esse arquivo
contém apenas a chamada dessas receitas, como no exemplo abaixo:

\begin{lstlisting}[language=Ruby,label=dice_index,caption={Exemplo da receita de email
composta por outras receitas}]
include_recipe 'email::dovecot'
include_recipe 'email::postfix'
include_recipe 'email::spamassasin'
\end{lstlisting}

A função de \textit{include\_recipe} do Chef permite que, aplicações que são compostas
por outras aplicações menores, possam ter suas receitas separadas em diferentes arquivos,
sendo um arquivo para cada aplicação menor, que compõe o todo. Com isso, é possível 
incluir esses arquivos na receita que será executada. No caso do Shak, a receita
que sempre será executada é a receita que está no arquivo \textit{default.rb} na
pasta \textit{recipe}.

\subsection{Configuração}

Como levantado no planejamento, é necessário a edição de arquivos de configuração
de todas as ferramentas. Existem arquivos de configuração para cada uma delas, inclusive
o dovecot, que precisa ser integrado com o postfix, como agência de transferência
de e-mails.

Primeiramente, para a configuração do dovecot, foi utilizado 5 arquivos
de configuração, o primeiro é o \textit{10-mail.conf} que é um arquivo de configuração para
indicar onde é o local no qual os e-mails estão. O segundo arquivo, é o \textit{10-ssl.conf}
que é o arquivo em que possui os caminhos do certificado \textit{SSL} e da chave \textit{SSL}.

O terceiro arquivo é o arquivo \textit{11-postfix-auth.conf}, arquivo responsável por 
indicar o caminho do arquivo de autenticação
do postfix. O quarto arquivo é o arquivo \textit{20-imap.conf}, onde é indicado o tamanho
máximo de conexões por ip permitidas no servidor. Por fim o arquivo
\textit{20-disable-imap-non-ssl.conf}, que permitirá que o imap utilize sempre uma conexão
segura utilizando o \textit{IMAPS} (\textit{IMAP} + \textit{SSL}), assim bloqueando 
qualquer conexão ou tentativa de conexão insegura.

Para o posfix, são apenas dois arquivos de configuração, o \textit{main.cf} e o 
\textit{master.cf}.
O \textit{main.cf} é aonde se configura os parâmetros mínimos de configuração, esse arquivo
também contém as configurações que filtram os e-mails com spamassassin e 
algumas configurações do \textit{SMTP}. 

No \textit{master.cf}, é definido como um programa cliente se conecta a um serviço, e qual o
programa que é executado quando um serviço é solicitado. Neste caso, é necesário
indicar que o servidor de e-mail utilize \textit{SSL}, com autenticação segura, 
apontando o caminho dos arquivos de chave e certificados.

Por fim, a configuração do spamassasin. São necessários dois arquivos de configuração.
O arquivo \textit{spamassassin}, que é o arquivo de configurações padrão para o spamassasin e o
\textit{local.cf} que são as configurações locais. No spamassassin, é preciso habilitar 
o serviço do spamassasin e configurar o caminho dos arquivo de log.

Já o arquivo \textit{local.cf} possui o parâmetro required\_score. Esse parâmetro 
possui um nível de 0 a 10, em que 
são classificados os e-mails como spam. Por padrão esse valor é cinco, porém se 
o usuário quiser aumentar o filtro pode aumentar para valores como seis ou sete, 
até chegar em um nível de confiança em que o spamassasin cuide dos casos falsos-positivos, 
ou seja, e-mails que não são spam porém foram interpretados como spam.

\subsection{Inicialização}

Após a construção da receita do servidor de e-mail, é necessário testar a receita construída,
para isso, o Shak precisa de duas informações importantes. A primeira é a aplicação
que será instalada, e segunda o hostname destino, para executar a instalação
do servidor de e-mail basta:

\begin{lstlisting}[language=Ruby,label=dice_index,caption={Exemplo de execução de instalação do servidor de e-mailcom shak}]
Shak install e-mail hostname=owncloud.dev
\end{lstlisting}


E assim o Chef inicia o processo de instalação dos pacotes; criação dos arquivos
de configuração; incia os serviços desejados; e ao fim do procedimento a aplicação
já estará pronta para uso no hostname escolhido.

Para testar o funcionamento foram feitos dois procedimentos, o primeiro, era utilizar
um cliente de e-mail para testes, o cliente de e-mail escolhido foi o mutt, utilizando
suas funções básicas de enviar e receber e-mails. O segundo passo, foi realizar conexões
com o servidor de e-mail via telnet, com os seguintes comandos:

\begin{lstlisting}[language=Ruby,label=dice_index,caption={Exemplo de teste de conexão telnet no servidor imap}]
  telnet localhost imap
  telnet localhost imaps
\end{lstlisting}

Pela configuração do servidor de e-mail, não foi possível abrir uma conexão telnet
com o parâmetro imap, porém com o parâmetro imaps foi possível, isso serviu para testar 
que o servidor de e-mail impediu conexões que não 
utilizem os protocolos criptografados.

\section{MoinMoin}
\label{sub:moinmoin}

MoinMoin é uma ferramenta de construção
de wikis, com uma grande comunidade de usuários, podendo criar páginas web
facilmente editáveis. MoinMoin é software livre, alguns exemplos
de wiki que utilizam o MoinMoin são: Wiki do debian, Wiki do python e Wiki do apache,
contendo várias documentações relacionado aos seus softwares \cite{moin}. 

Para a implantação automatizada do MoinMon, foram seguidos os mesmos passos
feitos em Wordpress \ref{sub:wordpress} e Owncloud \ref{sub:owncloud}.

\subsection{Planejamento}

Primeiramente, é necessário definir quais são as dependências
mínimas para o funcionamento do MoinMoin, tais como banco de dados; pacotes
pré-instalados; e aplicações pré-configuradas. Para o MoinMoin são elas:

\begin{itemize}
   \item \textbf{Pacote python-moinmoin para o Debian:} Pacote Debian com o MoinMoin.
   \item \textbf{Pacote Nginx para o Debian:} Pacote Debian com o Nginx.
   \item \textbf{Pacote uwsgi para o Debian:} Pacote Debian com o servidor de aplicação web
uwsgi, com suporte para aplicações escritas em python, utilizando o plugin uwsgi-plugin-python,
também disponível como um pacote debian.
   \item \textbf{Arquivos de configuração:} Criação dos arquivos de configuração
   necessários para configurar o Uwsgi, o servidor web Nginx e o servidor web
uwsgi.
\end{itemize}

Diferentemente das outras aplicações web, moinmoin não utiliza banco de dados.

\subsection{Preparação e Instalação de Pacotes}

Para o funcionamento correto do moinmoin, é necessário a instalação do python, além
disso, também é necessário o uso de algum servidor web. No caso, utilizaremos o Nginx
junto ao uwsgi, também é necessário a configuração do moinmoin a partir de seus
arquivos de configuração, mywiki.py e farmconfig.py.

Para esse procedimento, foi necessário instalar os pacotes uwsgi,
uwsgi-plugin-python, e o pacote do moinmoin, chamado python-moinmoin.
Para executar essas instalações, é preciso criar uma receita no livro de receitas
do moinmoin, bastando executar o comando \textit{rake cookbook}, que cria a
estrutura básica de um livro de receitas que deve ser usado pelo Chef, como no exemplo
abaixo:

\begin{lstlisting}[language=Ruby,label=dice_index,caption={Exemplo de criação de estrutura básica de livro de receitas do moinmoin com shak}]
  rake cookbook
  Cookbook name: moinmoin
  knife cookbook create moinmoin -o cookbooks/
  ** Creating cookbook foo in /home/thiago/Shak/cookbooks
  ** Creating README for cookbook: moinmoin
  ** Creating CHANGELOG for cookbook: moinmoin
  ** Creating metadata for cookbook: moinmoin
\end{lstlisting}

Assim, com a estrutura inicial, é possível declarar as dependências do moinmoin
dentro do arquivo \textit{default.rb} dentro da pasta \textit{recipes}.Esse arquivo 
é aonde se declara os pacotes que devem ser instalados; os arquivos de configuração;
os serviços que precisar executar; as pastas; permissões de usuários; dentre outros.

\subsection{Configuração}

Como levantado no planejamento, é necessário a edição de arquivos de configuração
do moinmoin; arquivos de configuração do uwsgi; e arquivo de configuração
do Nginx.

O primeiro arquivo de configuração é o moin.wsgi, arquivo onde é necessário
informar, por exemplo, o caminho dos arquivos de configuração do moinmoin. No caso
de um pacote debian, esse caminho por padrão é  /etc/moin. Também é necessário 
editar o arquivo uwsgi.ini, que é o arquivo de configuração
do uwsgi para sua aplicação. Nele, é possível adicionar informações importantes, como
por exemplo aonde será o arquivo de log do uwsgi; aonde será criado seu socket;
e a quantidade máxima de requisições.

O primeiro arquivo de configuração é o mywiki.py, onde é necessário
informar informações básicas de sua wiki, como o nome da sua wiki e seu diretório de dados. 
O segundo arquivo de configuração é o farmconfig.py, que é o responsável pelos 
links da barra de navegação e responsável por configurar múltiplas instâncias.

Além disso, é necessário criar a pasta de conteúdos do moinmoin, que por
escolha devem ficar em /var/lib/moin. Após isso, para que o Nginx funcione corretamente
com o uwsgi, é necessário indicar o socket do uwsgi, que foi indicado no uwsgi.ini.

\subsection{Múltiplas Instâncias}

MoinMoin possui nativamente a funcionalidade que permite a criação de múltiplas 
instâncias de wiki no mesmo servidor. Para isso, é necessário editar um arquivo,
que é chamado de \textit{farmconfig.py}, com todas as wikis, e com seus 
respectivos identificadores e domínios. Assim o MoinMoin consegue gerenciar as 
wikis separadamente. 

Uma outra etapa, é fazer com que o Shak entenda que existem outras wikis já 
configuradas. A cada nova instância
o arquivo \textit{farmconfig.py} deve ser atualizado com as novas 
informações de wiki, sem remover as
informações das outras wikis anteriormente inseridas. Para isso, é adicionado
numa lista de wikis, para que a cada vez que surja uma wiki nova, apenas as
informações novas são inseridas no arquivo farmconfig.py.

\subsection{Inicialização}

Após a construção da receita do MoinMoin, é necessário testar a receita construída,
para isso o Shak precisa de duas informações importantes, a primeira é a aplicação
que será instalada, e segunda o hostname destino, para executar a instalação
do Owncloud basta:

\begin{lstlisting}[language=Ruby,label=dice_index,caption={Exemplo de execução de instalação do owncloud com shak}]
shak install moinmoin hostname=moinmoin.dev
\end{lstlisting}

E assim, o Chef inicia o processo de instalação dos pacotes; criação dos arquivos
de configuração; incia os serviços desejados; e ao fim do procedimento a aplicação
já estará pronta para uso no hostname escolhido.

\section{Segurança}
\label{sub:seguranca}

Na implantação das aplicações web foram feitos dois procedimentos de segurança, o primeiro
é forçar as aplicações web a sempre utilizarem o protocolo \textit{HTTP} e a segunda foi forçar o
servidor de e-mail a não permitir a conexão via protocolos sem criptografia. Neste
caso, sendo o protocolo imap utilizando o protocolo \textit{imaps}. Para que 
isso fosse possível, foi necessário gerar um certificado \textit{SSL}. Certificados 
\textit{SSL} são necessários para que um determinado serviço opere com suporte 
a conexão segura por meio de criptografia.
É de conhecimento do autor que a melhor forma é obter um certificado assinado
por uma certificadora registrada, porém inicialmente foi trabalhado apenas com certificados
autoassinados.

Para suprir a necessidade das aplicações, cada aplicação terá um certificado para
si, além disso o servidor também terá o seu certificado autoassinado. Isso foi necessário
para que as aplicações possam ser instaladas em diferentes servidores, por
isso, é necessário garantir que cada servidor possua o seu certificado. 

Para adicionar esse novo suporte ao Shak, foi necessário criar uma receita Chef,
para que possa gerenciar os certificados \textit{SSL}. Optou-se por utilizar a ferramenta
openssl para geração das chaves e certificados, o openssl é uma ferramenta de
implementação do Transport Layer Security \textit{TLS} e Secure Sockets Layer \textit{SSL},
além de ser uma biblioteca de propósito geral de criptografia \cite{openssl}.

Esse novo componente no Shak é composto basicamente do pacote openssl, além da criação
de certificados autoassinados utilizando o openssl. Os certificados são gerados 
para cada aplicação e para o servidor. O caminho dos arquivos dos certificados que 
são gerados é /etc/ssl/certs/hostname.pem, onde hostname é o endereço do servidor
e o caminho onde as chaves são geradas é /etc/ssl/private/hostname.key.

Com as chaves geradas, basta configurar as aplicações indicando os caminhos dos certificados
e das chaves, para forçar as aplicações web a utilizarem o \textit{HTTP} foi necessário fazer
uma configuração específica no servidor web Nginx:

\begin{lstlisting}[language=Ruby,label=dice_index,caption={Exemplo de arquivo de configuração do Nginx para aplicações web no shak}]
  server {
      server_name <%= @hostname %>;
      rewrite     \^https://\$server\_name\$request\_uri? permanent;
  }

  server {
      server_name <%= @hostname %>;

      listen 443 ssl;
      ssl_certificate       /etc/ssl/certs/<%= @hostname %>.pem;
      ssl_certificate_key   /etc/ssl/private/<%= @hostname %>.key;

      access_log            /var/log/nginx/<%= @hostname %>.access.log;
      error_log             /var/log/nginx/<%= @hostname %>.error.log;

      include /var/lib/Shak/etc/nginx/<%= @hostname %>/*.conf;
  }
\end{lstlisting}

Com isso, todas as requisições serão forçadas a utilizar a porta 443 que é a porta
\textit{TCP} padrão para sites que utilizam \textit{HTTP} e \textit{SSL}. Assim, 
as aplicações utilizarão um protocolo mais seguro, utilizando criptografia dos dados
, utilizando o certificado autoassinado que foi gerado para o servidor específico.

\section{Protótipo da aplicação web}
\label{sub:prototipo}

%TODO colocar figura, o que agregou valor ao usuário, etc.
%TODO quebrar em parágrafos, descrever a figura.
%TODO mostrar os passos na ferramenta
%TODO ver se sobe essa parte da interface no começo dos resultados.
Outro resultado obtido neste trabalho foi a proposta de um protótipo para a interface
web da aplicação, como um dos objetivos do Shak é possuir uma interface web para que
os usuários não precisem utilizar um terminal para realizar as ações, também foi
feito um protótipo funcional, para ser aplicado no shak. O protótipo foi feito
na ferramenta chamada Pingendo, que é um software livre utilizado para construir
protótipos funcionais. Além de ter um protótipo funcional, a ferramenta Pingendo
também gera o código \textit{HTML} e \textit{CSS}, que pode ser aproveitado para 
a construção do layout do Shak. A sugestão inicial foi feita utilizando \textit{HTML} e \textit{CSS} utilizando
bootstrap 3, que é um framework para criar aplicações responsivas na web. A versão
inicial está disponível em \href{https://gitlab.com/Thiagovsk/shak_frontend/tree/master}.

%TODO
\section{Aplicações não encerradas}
\label{sub:appnencerradas}

Até o fim deste trabalho as aplicações Noosfero e Roundcube não foram finalizadas,
porém, é importante reportar o estado atual do que foi feito neste trabalho,
com essas duas aplicações.

\subsubsection{Noosfero}
\label{subsub:noosfero}

Noosfero \citeonline{noosfero} é uma plataforma web para redes sociais e 
de economia social e solidária. Ela possui funcionalidades como blog; e-Porfolios; 
CMS; RSS; discussão temática; agenda de eventos; e inteligência coletiva para a 
economia solidária no mesmo sistema.

O estado atual da aplicação Noosfero no Shak econtra-se
na fase do planejamento. No planejamento, já era de conhecimento do autor que o
Noosfero não estava nos repositórios oficiais do Debian, mas que seria possível, 
desde que todas as dependências do Noosfero também estivessem no Debian.

O Noosfero já possui um repositório \footnote{http://download.noosfero.org/debian/jessie/}
com suas dependências empacotadas, porém, algumas delas não se encontram nos repositórios
oficiais do Debian. Um exemplo é a biblioteca \textit{ruby-selenium-webdriver}, que
está no repositório do Noosfero, porém não está disponível no repositório oficial
do Debian. Outro problema que foi encontrado, é que algumas dependências do noosfero
estão em versões diferentes das dependências que estão no repositório Debian.

Para resolver esse problema, seria necessário empacotar todas as dependências
do Noosfero que ainda não estão no Debian. Além disso, sincronizar as versões
que já estão no Debian, com as versões que são utilizadas pelo Noosfero.

Abaixo, encontra-se uma lista das dependências que estão no repositório do Noosfero,
com suas versões, e as dependências que estão no Debian Jessie.

\begin{table}[H]
    \begin{tabular}{l|l}
        \hline
        Repositório do Noosfero Debian Jessie & Repositório oficial do Debian Jessie                   \\ \hline
        bundler (1.10.6)                                 & bundler (1.7.4-1)                                                 \\ 
        Noosfero Apache (1.5)                            & inexistente                                                       \\ 
        Noosfero Chat (1.5)                              & Inexistente                                                       \\ 
        Rails (4.2.5)                                    & Rails (4.1.8-1+deb8u2)                                            \\ 
        ruby-actionmailer (4.2.5)                        & ruby-actionmailer (4.1.8)                                         \\ 
        ruby-actionpack-page-caching (1.0.2)             & Apenas na versão testing/unstable (1.2.0)  \\ 
        ruby-actionpack (4.2.5)                          & ruby-actionpack (4.1.8)                                           \\ 
        ruby-actionview (4.2.5)                          & ruby-actionview (4.1.8)                                           \\ 
         ruby-activejob (4.2.5)                          & Apenas na versão testing/unstable (4.2.6)  \\ 
        ruby-activemodel (4.2.5)                         & ruby-activemodel (4.1.8)                                          \\ 
        ruby-activerecord-deprecated-finders (1.0.4)     & ruby-activerecord-deprecated-finders (1.0.3)                      \\ 
        ruby-activerecord-session-store (0.1.1)          & Apenas na versão testing/unstable (1.0.0)  \\ 
        ruby-activerecord (4.2.4)                        & ruby-activerecord (4.1.8)                                         \\ 
        ruby-activesupport (4.2.5.1)                     & ruby-activesupport (4.1.8)                                        \\ 
        ruby-acts-as-taggable-on (3.5.0)                 & ruby-acts-as-taggable-on (2.4.1)                                  \\ 
         ruby-api-pagination (4.2.0)                     & Apenas na versão testing/unstable (4.2.0)  \\ 
        ruby-arel (6.0.3)                                & ruby-arel (5.0.1)                                                 \\ 
        ruby-axiom-types (0.1.1)                         & ruby-axiom-types (0.1.1)                                         \\ 
        ruby-binding-of-caller (0.7.2)                   & Apenas na versão testing/unstable (0.7.2)  \\ 
        ruby-byebug (5.0.0)                              & Apenas na versão testing/unstable (5.0.0)  \\ 
        ruby-chronic (0.10.2)                            & ruby-chronic (0.10.2)                                             \\ 
        ruby-coffee-rails (4.1.0)                        & ruby-coffee-rails (4.0.1)                                         \\ 
        ruby-columnize (0.9.0)                           & ruby-columnize (0.8.9)                                            \\ 
        ruby-cucumber-rails (1.4.2)                      & Apenas na versão testing/unstable (1.4.2)  \\ 
        ruby-dalli (2.7.4)                               & Apenas na versão testing/unstable (2.7.4)  \\ 
        ruby-debug-inspector (0.0.2)                     & Apenas na versão testing/unstable (0.0.2)  \\ 
         ruby-delayed-job-active-record (4.0.3)          & Apenas na versão testing/unstable (4.0.3)  \\ 
        ruby-delayed-job (4.0.6)                         & Apenas na versão testing/unstable (4.0.6)  \\ 
        ruby-doorkeeper (2.2.1)                          & Apenas na versão testing/unstable (3.1.0)  \\ 
        ruby-eita-jrails (0.10.0)                        & Inexistente no Debian                                             \\ 
        ruby-fast-gettext (0.9.2)                        & ruby-fast-gettext (0.9.0)                                         \\ 
        ruby-globalid (0.3.6)                            & Apenas na versão testing/unstable (0.3.6)  \\ 
        ruby-grape-entity (0.4.8)                        & Apenas na versão testing/unstable (0.5.1)  \\ 
        ruby-grape-logging (1.1.2)                       & Apenas na versão testing/unstable (1.3.0)  \\ 
        ruby-grape (0.12.0)                              & Apenas na versão testing/unstable (0.16.0) \\ 
        ruby-hashie (3.4.2)                              & ruby-hashie (2.0.5)                                               \\ 
        ruby-i18n (0.7.0)                                & ruby-i18n (0.6.9)                                                 \\ 
        ruby-ice-nine (0.11.1)                           & ruby-ice-nine (0.11.0)                                            \\ 
        ruby-launchy-shim (2.3.0)                        & Apenas na versão testing/unstable (2.3.0)  \\ 
        ruby-liquid (3.0.4)                              & ruby-liquid (2.6.1)                                               \\ 
        ruby-loofah (2.0.3)                              & Apenas na versão testing/unstable (2.0.3)  \\ 
        ruby-minitest-reporters (1.0.19)                 & Apenas na versão testing/unstable (1.0.19) \\ 
        ruby-molinillo (0.2.3)                           & Apenas na versão testing/unstable (0.5.0)  \\ 
        ruby-oauth2 (1.0.0)                              & ruby-oauth2 (0.9.3)                                               \\ 
        ruby-omniauth-google-oauth2 (0.2.6)              & ruby-omniauth-google-oauth2 (0.2.4)                               \\ 
        ruby-omniauth-oauth2 (1.3.1)                     & ruby-omniauth-oauth2 (1.1.2)                                      \\ 
        ruby-omniauth (1.3.1)                            & ruby-omniauth (1.2.1)                                             \\ 
        ruby-pothoven-attachment-fu (3.2.16)             & Inexistente no Debian                                             \\ 
        ruby-progressbar (1.4.2)                         & ruby-progressbar (0.21.0)                                         \\
        ruby-protected-attributes (1.1.3)                & ruby-protected-attributes (1.0.8)                                  \\
        ruby-rack-accept (0.4.5)                         & ruby-rack-accept (0.4.5)                                  \\
        ruby-rack-contrib (1.3.0)                        & Apenas na versão testing/unstable (1.3.0)                                  \\
        ruby-rack-mount (0.8.3)                          & Apenas na versão testing/unstable (0.8.3)                                  \\
        ruby-rack (1.6.4)                                & ruby-rack (1.8.3)                                  \\
        ruby-rails-deprecated-sanitizer (1.0.3)          & Apenas na versão testing/unstable (1.0.3)                                  \\
        ruby-rails-dom-testing (1.0.6)                   & Apenas na versão testing/unstable (1.0.6)                                  \\
        ruby-rails-html-sanitizer (1.0.2)                & Apenas na versão testing/unstable (1.0.3)                                  \\
        ruby-rails-observers (0.1.2)                     & ruby-rails-observers (0.1.1)                                  \\
        ruby-railties (4.2.4)                            & ruby-railties (4.2.6)                                  \\
        ruby-rakismet (1.5.2)                            & Inexistente no Debian                                  \\
        ruby-rspec-rails (3.3.3)                         & Apenas na versão testing/unstable (2.14.2)                                  \\
        ruby-selenium-webdriver (2.50.0)                 & Inexistente no Debian                                  \\
        ruby-spy (0.4.2)                                 & Apenas na versão testing/unstable (0.4.3)                                  \\
        ruby-thread-order (1.1.0)                        & Apenas na versão testing/unstable (1.1.0)                                  \\
        ruby-thread-safe (0.3.5)                         & ruby-thread-safe (0.3.1)                                  \\
        ruby-turbolinks (2.5.3)                          & ruby-turbolinks (2.2.2)                                  \\
        ruby-web-console (2.2.1)                         & Apenas na versão testing/unstable (2.2.1)                                  \\
        ruby-whenever (0.9.4)                            & Apenas na versão testing/unstable (0.9.4)                                  \\
        ruby-will-paginate (3.0.7)                       & ruby-will-paginate (3.0.5)                                  \\
        ruby-xpath (2.0.0)                               & ruby-xpath (2.0.0)                                  \\
        \hline
    \end{tabular}
\caption{Diferença das versões dos pacotes do Noosfero, no repositório do Debian e no repositório do Noofero}
\end{table}

%TODO corrigir a mencao a tabela
Como visto na tabela acima, grande parte das dependências do Noosfero econtram-se
 apenas nas versões \textit{testing} e \textit{unstable} no Debian. Para a continuar com
a implantação automatizada, seria necessário discutir alguma solução 
com a comunidade do software. Como sugestão, uma das soluções viáveis seria, 
sincronizar as versões das dependências do Noosfero, com as versões que são 
disponibilizadas pelo Debian \textit{testing}, com isso, o 
Noosfero passa a ter boa parte de suas dependências suportadas pelo Debian. Além disso, 
também seria necessário empacotar as bibliotecas que o Noosfero precisa, mas 
que o Debian não possui. 

Porém, essa decisão fica a cargo da comunidade da aplicação, e com essa questão 
resolvida, o Shak poderá dar suporte ao Noosfero, em trabalhos futuros.

 \subsection{Roundcube}
\label{sub:owncloud}

Roundcube \citeonline{roundcube} é uma solução de webmail gratuita, de código 
aberto. Possui uma interface funcional e personalizável. Com ele, é possível
ler seus emails a partir de um cliente web. 

Para a ferramenta Roundcube, foram seguidos os mesmos passos feitos em 
\ref{sub:wordpress} e \ref{sub:owncloud}.

\subsection{Planejamento}

Inicialmente, é necessário definir quais são as dependências
mínimas para o funcionamento do Roundcube, tais como: banco de dados; pacotes
pré-instalados; e aplicações pré-configuradas. Roundcube é uma aplicação escrita
na linguagem Php, logo, suas dependências são bem semelhantes entre as aplicações
Wordpress e Owncloud. Foram identifcados:

\begin{itemize}
   \item \textbf{Pacote Roundcube para o Debian:} Pacote Debian com o Owncloud.
   \item \textbf{Pacote Nginx para o Debian:} Pacote Debian com o Nginx.
   \item \textbf{Pacote Postgresql para o Debian:} Pacote Debian com o banco de dados Postgresql
   que será usado pelo Roundcube.
   \item \textbf{Arquivos de configuração:} Criação dos arquivos de configuração
   necessários para configurar o Roundcube, o servidor web Nginx e o banco de dados
   Postgresql.
\end{itemize}

\subsection{Preparação e Instalação de Pacotes}

Para o funcionamento do ROundcube, é necessário a instalação do Php5. Além
disso, também foi utilizado o servidor web Nginx, e o 
banco de dados Postgresql.

Para faciltiar a configuração de aplicações Php, foi feito uma receita genérica,
que instala dependências básicas para qualquer aplicação Php que for usada pelo
Shak. Essa receita instala e habilita o Php5, além de instalar o nginx. A partir
disto, as aplicações Owncloud e Wordpress também passaram a usar esta receita
genérica, removendo duplicações de suas receitas.

Por fim, também foi necessário instalar o pacote roundcube-pgsql, que é um módulo 
necessário para que Roundcube funcione com o banco de dados PostgeSQL.
 
Para executar essas instalações, é preciso criar uma receita no livro de receitas
do Roundcube, com o comando \textit{rake cookbook}, da mesma forma com as outras aplicações.
 
Com a estrutura inicial, é possível declarar as dependências do Roundcube
dentro do arquivo \textit{default.rb}, que se encontra dentro da pasta 
\textit{recipes}. 

\subsection{Configuração}

O estado atual da aplicação Roundcube no Shak, econtra-se na fase de configuração. A pendência
é a configuração do servidor de email, que será utilizado pelo roundcube. Por ser
uma configuração pessoal do usuário, ou seja, ele deve inserir o seu serviço
de email preferido, essa configuração ainda não foi automatizada. 

Como sugestão de trabalhos futuros, é necessário evoluir a receita do Roundcube para receber os dados do serviço de email, fornecidos pelo usuário, durante sua instalação. Com 
isso, ao finalizar a instalação, o Roundcube já estará disponível ao usuário, 
com a conta de email que foi informada.

Atualmente, a receita do Roduncube ja automatiza a instalação da sua aplicação web. 
O tralho atual está disponível no repositório oficial do Shak \footnote{https://gitlab.com/shak/shak/branches}, na branch roundcube.

